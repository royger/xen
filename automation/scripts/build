#!/bin/bash -ex

test -f /etc/os-release && cat "$_"

# Construct $cc such that it matches what `make` will chose when taking
# CROSS_COMPILE into account.  Do not modify $CC directly, as that will cause
# `make` to double-account CROSS_COMPILE.
cc="${CROSS_COMPILE}${CC}"

$cc --version

# random config or default config
if [[ "${RANDCONFIG}" == "y" ]]; then

    # Append job-specific fixed configuration
    if [[ -n "${EXTRA_FIXED_RANDCONFIG}" ]]; then
        echo "${EXTRA_FIXED_RANDCONFIG}" >> xen/tools/kconfig/allrandom.config
    fi

    make -j$(nproc) -C xen KCONFIG_ALLCONFIG=tools/kconfig/allrandom.config randconfig

    # RANDCONFIG implies HYPERVISOR_ONLY
    HYPERVISOR_ONLY="y"
else
    echo "CONFIG_DEBUG=${debug}" > xen/.config

    if [[ -n "${EXTRA_XEN_CONFIG}" ]]; then
        echo "${EXTRA_XEN_CONFIG}" >> xen/.config
    fi

    make -j$(nproc) -C xen olddefconfig
fi

# Save the config file before building because build failure causes the script
# to exit early -- bash is invoked with -e.
cp xen/.config xen-config

# Directory for the artefacts to be dumped into
mkdir binaries

if [[ "${CPPCHECK}" == "y" ]] && [[ "${HYPERVISOR_ONLY}" == "y" ]]; then
    # Cppcheck analysis invokes Xen-only build.
    # Known limitation: cppcheck generates inconsistent reports when running
    # in parallel mode, therefore do not specify -j<n>.
    xen/scripts/xen-analysis.py --run-cppcheck --cppcheck-misra

    # Preserve artefacts
    cp xen/xen binaries/xen
    cp xen/cppcheck-report/xen-cppcheck.txt xen-cppcheck.txt
elif [[ "${HYPERVISOR_ONLY}" == "y" ]]; then
    # Xen-only build
    make -j$(nproc) xen

    # Preserve artefacts
    cp xen/xen binaries/xen
else
    # Full build.  Figure out our ./configure options
    cfgargs=()
    cfgargs+=("--enable-docs")

    # booleans for which compiler is in use
    cc_is_gcc="$($cc --version | grep -q gcc && echo "y" || :)"
    cc_is_clang="$($cc --version | grep -q clang && echo "y" || :)"

    # The compiler version as an integer.  e.g. GCC 4.9.2 => 0x040902
    cc_ver="$($cc -dumpversion | awk -F. '{ printf "0x%02x%02x%02x", $1, $2, $3 }')"

    if [[ "${cc_is_clang}" == "y" ]]; then
        # SeaBIOS cannot be built with clang
        cfgargs+=("--with-system-seabios=/usr/share/seabios/bios.bin")
        # iPXE cannot be built with clang
        cfgargs+=("--with-system-ipxe=/usr/lib/ipxe/ipxe.pxe")
        # newlib cannot be built with clang so we cannot build stubdoms
        cfgargs+=("--disable-stubdom")
    fi

    if ldd /bin/ls | grep -q musl; then
        # disable --disable-werror for QEMUU when building with MUSL
        cfgargs+=("--with-extra-qemuu-configure-args=\"--disable-werror\"")
        # SeaBIOS doesn't build on MUSL systems
        cfgargs+=("--with-system-seabios=/bin/false")
    fi

    # Qemu requires Python 3.5 or later, and ninja
    if ! type python3 || python3 -c "import sys; res = sys.version_info < (3, 5); exit(not(res))" \
            || ! type ninja; then
        cfgargs+=("--with-system-qemu=/bin/false")
    fi

    # SeaBIOS requires GCC 4.6 or later
    if [[ "${cc_is_gcc}" == "y" && "${cc_ver}" -lt 0x040600 ]]; then
        cfgargs+=("--with-system-seabios=/bin/false")
    fi

    ./configure "${cfgargs[@]}"
    make -j$(nproc) dist

    # Preserve artefacts
    # Note: Some smoke tests depending on finding binaries/xen on a full build
    # even though dist/ contains everything, while some containers don't even
    # build Xen
    cp -r dist binaries/
    if [[ -f xen/xen ]] ; then cp xen/xen binaries/xen; fi
fi

if [[ "$LIVEPATCH" == "y" ]]; then
    # Build a test livepatch using livepatch-tools.

    BUILDID=$(readelf -Wn xen/xen-syms | sed -n -e 's/^.*Build ID: //p')

    git clone https://xenbits.xen.org/git-http/livepatch-build-tools.git
    cd livepatch-build-tools
    make
    ./livepatch-build -s ../ -p ../xen/test/livepatch/test.patch -o out \
        -c ../xen/.config --depends $BUILDID --xen-depends $BUILDID
    cp out/test.livepatch ../binaries/test.livepatch
fi
